# Caddyfile for AI School Platform
# Handles SSL termination, reverse proxy, and security headers
# Domain: thestai.com with wildcard subdomains for multi-tenancy

# Global options
{
	# Email for Let's Encrypt SSL certificates
	email {$ACME_EMAIL:admin@thestai.com}

	# Use staging for testing (uncomment to avoid rate limits)
	# acme_ca https://acme-staging-v02.api.letsencrypt.org/directory
}

# Main domain and all subdomains
{$DOMAIN:thestai.com}, *.{$DOMAIN:thestai.com} {
	# Reverse proxy to Next.js application
	reverse_proxy nextjs:3000 {
		# Health checks
		health_uri /api/health
		health_interval 30s
		health_timeout 10s

		# Pass original host header for multi-tenancy
		header_up Host {host}
		header_up X-Real-IP {remote_host}
		header_up X-Forwarded-For {remote_host}
		header_up X-Forwarded-Proto {scheme}
	}

	# Security headers
	header {
		# Prevent clickjacking
		X-Frame-Options "SAMEORIGIN"

		# Prevent MIME type sniffing
		X-Content-Type-Options "nosniff"

		# XSS protection
		X-XSS-Protection "1; mode=block"

		# Referrer policy
		Referrer-Policy "strict-origin-when-cross-origin"

		# Permissions policy
		Permissions-Policy "camera=(), microphone=(), geolocation=()"

		# HSTS - enforce HTTPS
		Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"

		# Content Security Policy
		Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self' https://api.anthropic.com;"

		# Remove server header
		-Server
	}

	# Enable gzip compression
	encode gzip

	# Logging
	log {
		output file /var/log/caddy/access.log {
			roll_size 10mb
			roll_keep 5
		}
		format json
	}
}

# Health check endpoint for load balancers (if using Cloudflare)
:8080 {
	respond /health "OK" 200
}
